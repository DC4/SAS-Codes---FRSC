
**************************************************************************************

				Merchant Impact for Non Major

**************************************************************************************;
 
LIBNAME EXIST "C:\Users\1510806\OneDrive - Standard Chartered Bank\Desktop\Jhilam\Falcon 6.4 Monthly Data";

%LET TOD = %SYSFUNC(TODAY(),date9.);
%put &tod.;

*********************************************************;

LIBNAME DB "C:\Users\1510806\OneDrive - Standard Chartered Bank\Desktop\Jhilam\Falcon 6.4 Monthly Data\Debit";

PROC DELETE DATA=mernm_top5; RUN;

%MACRO COP1(CNTY);

DATA XX;
SET 
	DB.FALT002_&CNTY._DB_OCT2021
	DB.FALT002_&CNTY._DB_NOV2021
	DB.FALT002_&CNTY._DB_DEC2021;
WHERE STRIP(MER_ID) IN 
('210760000200925',
'XQP1R7DWK5QEPSU',
'160146000762203',
'ZPC7NTPEBH8GEKM',
'Z4HHC3IL3GUEJGN',
'JR0J9RFDL9YARER',
'103800100000001',
'418889000200232',
'E0NI1OWGPANZPJY',
'418114000762203',
'NKDHX4LXNXBSFSD',
'6MJFN7HR5Q4XILS',
'OQ1FD8GOF0NL3LS',
'372176392887',
'YEDUBD75VBOW2N8',
'OQDZJQVAODF27CF',
'HEPKRZSMEVRC0MQ',
'TK07LZNWT0CI0VH',
'000445120538993',
'7P2ZDMEPIJ7OPHO',
'9118335',
'526567000868690',
'*54204378100013',
'LZPKIKAYMBLOUSQ',
'420429000208822',
'EUXC7LZIW2JPLCV',
'YK8KRPDGBWCHYND',
'4666C2CEQEN1IDC',
'46267512',
'0JAOPIA1EDSE4FP',
'013518749',
'Z8AVY57KPUIN1Q5',
'268128000209351',
'088011245821',
'QPMA6P4HFIWYGFN',
'SDEGYZILU1KB7UD',
'7017969',
'4556716632',
'248750000103177',
'4556728604',
'YNWFXKRUPAGKYUR',
'OXTUNKEKCK0U9P8',
'112127000108778',
'001170827000',
'32937255',
'UFLWE2216RINYGE',
'60TLHEG0D7YBR3B',
'HYRXVP2OURAIFR2',
'SGJHYVKU3MWULRB',
'088007968800',
'27970014',
'RYHB5IHLRORAQYH',
'G7OTELJTGC6SBWZ',
'WKF0RR2LR8GIYQH',
'420429000211321',
'A0000000000HI55',
'000027007704570',
'340201083624000',
'145863438',
'001918500661',
'298800300581873',
'181930000067204',
'2516340000',
'000445191569992',
'057181000156182',
'477715000203793',
'000001190700203',
'15877800600',
'027007705023',
'048800040008013',
'000311021521886',
'185119000762203',
'000980200425992',
'210758000200925',
'000102920051742',
'186516000067625',
'498750000022153',
'230120000200915',
'97515971',
'000001650044950',
'001111013264',
'001111651725',
'409986000201250',
'020395751',
'420429000211313',
'ACUMQGUWSXVY0OZ',
'001118969732',
'QZNHSMUYHCJS15U',
'000005444196000',
'859884000',
'212963000200925',
'464400000000854',
'001110253143',
'001117915496',
'480464000',
'000496219885886',
'000008010720',
'242865',
'J.W  MARRIOTT',
'200600027015',
'000532001',
'4556707188'
);
RUN;

PROC APPEND DATA=XX BASE=mernm_top5; RUN;

%MEND;


%COP1(AE);
%COP1(BD);
%COP1(BH);
%COP1(BN);
%COP1(BW);
%COP1(CI);
%COP1(CM);
%COP1(GH);
%COP1(GM);
%COP1(HK);
%COP1(ID);
%COP1(IN);
%COP1(JO);
%COP1(KE);
%COP1(LK);
%COP1(MY);
%COP1(NG);
%COP1(NP);
%COP1(QA);
%COP1(SG);
%COP1(SL);
%COP1(TW);
%COP1(TZ);
%COP1(UG);
%COP1(VN);
%COP1(ZM);
%COP1(ZW);


PROC SORT DATA=EXIST.FRD15 OUT=FRD_15 NODUPKEY; 
	BY PAN FITRANSACTIONIDREFERENCE; 
RUN;

PROC SORT DATA=mernm_top5 ; BY ACCT_NBR FI_TRANSACTION_ID DESCENDING FRD_IND; RUN;
PROC SORT DATA=mernm_top5 NODUPKEY; BY ACCT_NBR FI_TRANSACTION_ID; RUN;

PROC IMPORT DATAFILE="C:\Users\1510806\OneDrive - Standard Chartered Bank\Desktop\Jhilam\Dispute Merchant Analysis\Dispute Cases.xlsx" OUT=Dispute_txn dbms=xlsx replace; sheet="txn_id"; run;
PROC IMPORT DATAFILE="C:\Users\1510806\OneDrive - Standard Chartered Bank\Desktop\Jhilam\Dispute Merchant Analysis\Global_Dispute_Fraud_FI.xlsx" OUT=Global_Dispute_Fraud_FI dbms=xlsx replace; run;

PROC SQL;
CREATE TABLE TXN_DETAILS AS
		SELECT A.*,
		  B.FRAUDFLAG,
		  CASE 
			WHEN STRIP(UPCASE(A.FRD_IND)) IN ("Y" "D") OR B.FRAUDFLAG="1" OR C.FI_TRANSACTION_ID NE ""  OR D.FI_TRANSACTION_ID NE "" THEN 1 
		  END AS FRAUD
FROM mernm_top5 AS A LEFT JOIN FRD_15 AS B ON 
STRIP(A.CRD_CLNT_ID)=STRIP(B.CLIENTIDFROMHEADER) AND
STRIP(A.FI_TRANSACTION_ID)=STRIP(B.FITRANSACTIONIDREFERENCE)
LEFT JOIN Global_Dispute_Fraud_FI AS C ON 
STRIP(A.FI_TRANSACTION_ID)=STRIP(C.FI_TRANSACTION_ID)
LEFT JOIN Dispute_txn AS D ON
STRIP(A.FI_TRANSACTION_ID) = STRIP(D.FI_TRANSACTION_ID);
QUIT;

PROC SORT DATA=TXN_DETAILS NODUPKEY; BY FI_TRANSACTION_ID; RUN;

DATA FALT002;
     SET TXN_DETAILS;
   
     WHERE TRN_AUTH_POST="A" AND (AUTH_DECISION_XCD="A" OR DECI_CD_ORIG="A") AND TRN_TYP IN ("C" "M" "P");

     FORMAT TRAN_DATE DATE9.;
     TRAN_DATE = INPUT(SUBSTR(TRN_DT,1,2) || SUBSTR(TRN_DT,4,3) || '20' || SUBSTR(TRN_DT,8,2),DATE9.);
     ATTRIB AUTH_DTTM FORMAT=DATETIME19.;
     AUTH_DTTM=DHMS(TRAN_DATE,SUBSTR(TRN_DT,11,2),SUBSTR(TRN_DT,14,2),SUBSTR(TRN_DT,17,2)); 
	 COUNTRY = CRD_CLNT_ID;

	 OUTPUT;
	 IF CRD_CLNT_ID NE "" THEN DO; COUNTRY = "All_DB"; OUTPUT; END;
RUN;


PROC SQL;
CREATE TABLE db_Impact_Summary AS 
SELECT DISTINCT mer_id, mer_nm, COUNTRY, 
		COUNT(DISTINCT FI_TRANSACTION_ID) AS TXN_COUNT, 
		COUNT(DISTINCT ACCT_NBR) AS ACCT_COUNT, 
		SUM(FRAUD) AS NO_OF_FRAUDS,
		COUNT(DISTINCT CASE WHEN FRAUD=1 THEN ACCT_NBR END) AS NO_OF_CARDS_FRAUD, 
		CASE 
		 WHEN SUM(FRAUD) NE . THEN CALCULATED TXN_COUNT/CALCULATED NO_OF_FRAUDS
		 ELSE CALCULATED TXN_COUNT
		END AS TFPR,
		CASE 
		 WHEN SUM(FRAUD) NE . THEN CALCULATED ACCT_COUNT/CALCULATED NO_OF_CARDS_FRAUD
		 ELSE CALCULATED ACCT_COUNT
		END AS AFPR,
		ROUND(CALCULATED ACCT_COUNT/90,1) AS IMPACT_PER_DAY
FROM FALT002
group by mer_id, mer_nm, COUNTRY;
QUIT;





**************************************************************************************

				Credit Impact Summary

**************************************************************************************;


LIBNAME EXIST "C:\Users\1510806\OneDrive - Standard Chartered Bank\Desktop\Jhilam\Falcon 6.4 Monthly Data";

*********************************************************;


LIBNAME CR "C:\Users\1510806\OneDrive - Standard Chartered Bank\Desktop\Jhilam\Falcon 6.4 Monthly Data\Credit";

PROC DELETE DATA=mernm_top5; RUN;

%MACRO COP(CNTY);

DATA XX;
SET 
	CR.FALT002_&CNTY._CR_OCT2021
	CR.FALT002_&CNTY._CR_NOV2021
	CR.FALT002_&CNTY._CR_DEC2021;
WHERE STRIP(MER_ID) IN 
('210760000200925',
'XQP1R7DWK5QEPSU',
'160146000762203',
'ZPC7NTPEBH8GEKM',
'Z4HHC3IL3GUEJGN',
'JR0J9RFDL9YARER',
'103800100000001',
'418889000200232',
'E0NI1OWGPANZPJY',
'418114000762203',
'NKDHX4LXNXBSFSD',
'6MJFN7HR5Q4XILS',
'OQ1FD8GOF0NL3LS',
'372176392887',
'YEDUBD75VBOW2N8',
'OQDZJQVAODF27CF',
'HEPKRZSMEVRC0MQ',
'TK07LZNWT0CI0VH',
'000445120538993',
'7P2ZDMEPIJ7OPHO',
'9118335',
'526567000868690',
'*54204378100013',
'LZPKIKAYMBLOUSQ',
'420429000208822',
'EUXC7LZIW2JPLCV',
'YK8KRPDGBWCHYND',
'4666C2CEQEN1IDC',
'46267512',
'0JAOPIA1EDSE4FP',
'013518749',
'Z8AVY57KPUIN1Q5',
'268128000209351',
'088011245821',
'QPMA6P4HFIWYGFN',
'SDEGYZILU1KB7UD',
'7017969',
'4556716632',
'248750000103177',
'4556728604',
'YNWFXKRUPAGKYUR',
'OXTUNKEKCK0U9P8',
'112127000108778',
'001170827000',
'32937255',
'UFLWE2216RINYGE',
'60TLHEG0D7YBR3B',
'HYRXVP2OURAIFR2',
'SGJHYVKU3MWULRB',
'088007968800',
'27970014',
'RYHB5IHLRORAQYH',
'G7OTELJTGC6SBWZ',
'WKF0RR2LR8GIYQH',
'420429000211321',
'A0000000000HI55',
'000027007704570',
'340201083624000',
'145863438',
'001918500661',
'298800300581873',
'181930000067204',
'2516340000',
'000445191569992',
'057181000156182',
'477715000203793',
'000001190700203',
'15877800600',
'027007705023',
'048800040008013',
'000311021521886',
'185119000762203',
'000980200425992',
'210758000200925',
'000102920051742',
'186516000067625',
'498750000022153',
'230120000200915',
'97515971',
'000001650044950',
'001111013264',
'001111651725',
'409986000201250',
'020395751',
'420429000211313',
'ACUMQGUWSXVY0OZ',
'001118969732',
'QZNHSMUYHCJS15U',
'000005444196000',
'859884000',
'212963000200925',
'464400000000854',
'001110253143',
'001117915496',
'480464000',
'000496219885886',
'000008010720',
'242865',
'J.W  MARRIOTT',
'200600027015',
'000532001',
'4556707188');
RUN;

PROC APPEND DATA=XX BASE=mernm_top5; RUN;

%MEND;


%COP(AE);
%COP(BD);
%COP(BH);
%COP(BN);
%COP(BW);
%COP(GH);
%COP(HK);
%COP(ID);
%COP(IN);
%COP(JE);
%COP(JO);
%COP(KE);
%COP(LK);
%COP(MY);
%COP(NG);
%COP(NP);
%COP(SG);
%COP(TW);
%COP(VN);
%COP(ZM);
%COP(DR);

PROC SORT DATA=EXIST.FRD15 OUT=FRD_15 NODUPKEY; 
	BY PAN FITRANSACTIONIDREFERENCE; 
RUN;

PROC SORT DATA=mernm_top5 ; BY ACCT_NBR FI_TRANSACTION_ID DESCENDING FRD_IND; RUN;
PROC SORT DATA=mernm_top5 NODUPKEY; BY ACCT_NBR FI_TRANSACTION_ID; RUN;

PROC IMPORT DATAFILE="C:\Users\1510806\OneDrive - Standard Chartered Bank\Desktop\Jhilam\Dispute Merchant Analysis\Dispute Cases.xlsx" OUT=Dispute_txn dbms=xlsx replace; sheet="txn_id"; run;
PROC IMPORT DATAFILE="C:\Users\1510806\OneDrive - Standard Chartered Bank\Desktop\Jhilam\Dispute Merchant Analysis\Global_Dispute_Fraud_FI.xlsx" OUT=Global_Dispute_Fraud_FI dbms=xlsx replace; run;

PROC SQL;
CREATE TABLE TXN_DETAILS AS
		SELECT A.*,
		  B.FRAUDFLAG,
		  CASE 
			WHEN STRIP(UPCASE(A.FRD_IND)) IN ("Y" "D") OR B.FRAUDFLAG="1" OR C.FI_TRANSACTION_ID NE "" OR D.FI_TRANSACTION_ID NE "" THEN 1 
		  END AS FRAUD
FROM mernm_top5 AS A LEFT JOIN FRD_15 AS B ON 
STRIP(A.CRD_CLNT_ID)=STRIP(B.CLIENTIDFROMHEADER) AND
STRIP(A.FI_TRANSACTION_ID)=STRIP(B.FITRANSACTIONIDREFERENCE)
LEFT JOIN Global_Dispute_Fraud_FI AS C ON 
STRIP(A.FI_TRANSACTION_ID)=STRIP(C.FI_TRANSACTION_ID)
LEFT JOIN Dispute_txn AS D ON
STRIP(A.FI_TRANSACTION_ID) = STRIP(D.FI_TRANSACTION_ID);
QUIT;

PROC SORT DATA=TXN_DETAILS NODUPKEY; BY FI_TRANSACTION_ID; RUN;

DATA FALT002;
     SET TXN_DETAILS;
   
     WHERE TRN_AUTH_POST="A" AND (AUTH_DECISION_XCD="A" OR DECI_CD_ORIG="A") AND TRN_TYP IN ("C" "M" "P");

     FORMAT TRAN_DATE DATE9.;
     TRAN_DATE = INPUT(SUBSTR(TRN_DT,1,2) || SUBSTR(TRN_DT,4,3) || '20' || SUBSTR(TRN_DT,8,2),DATE9.);
     ATTRIB AUTH_DTTM FORMAT=DATETIME19.;
     AUTH_DTTM=DHMS(TRAN_DATE,SUBSTR(TRN_DT,11,2),SUBSTR(TRN_DT,14,2),SUBSTR(TRN_DT,17,2)); 
	 COUNTRY = CRD_CLNT_ID;

	 OUTPUT;
	 IF CRD_CLNT_ID NE "" THEN DO; COUNTRY = "All_CR"; OUTPUT; END;
RUN;


PROC SQL;
CREATE TABLE CR_Impact_Summary AS 
SELECT DISTINCT mer_id, mer_nm, COUNTRY, 
		COUNT(DISTINCT FI_TRANSACTION_ID) AS TXN_COUNT, 
		COUNT(DISTINCT ACCT_NBR) AS ACCT_COUNT, 
		SUM(FRAUD) AS NO_OF_FRAUDS,
		COUNT(DISTINCT CASE WHEN FRAUD=1 THEN ACCT_NBR END) AS NO_OF_CARDS_FRAUD, 
		CASE 
		 WHEN SUM(FRAUD) NE . THEN CALCULATED TXN_COUNT/CALCULATED NO_OF_FRAUDS
		 ELSE CALCULATED TXN_COUNT
		END AS TFPR,
		CASE 
		 WHEN SUM(FRAUD) NE . THEN CALCULATED ACCT_COUNT/CALCULATED NO_OF_CARDS_FRAUD
		 ELSE CALCULATED ACCT_COUNT
		END AS AFPR,
		ROUND(CALCULATED ACCT_COUNT/90,1) AS IMPACT_PER_DAY
FROM FALT002
group by mer_id, mer_nm, COUNTRY;
QUIT;


data impact_summary_&TOD.;
set db_impact_summary
	cr_impact_summary;
run;