
**************************************************************************************

				HR_Global_Int_CNP_NonSec_Score_1

**************************************************************************************;


LIBNAME INC "C:\Users\1510806\Desktop\Jhilam\Daily Data\CR";


*********************************************************;

DATA FALT002;
	SET 
INC.falt002_cr_02JUL
INC.falt002_cr_03JUL
INC.falt002_cr_04JUL;
     WHERE TRN_AUTH_POST = "A" AND AUTH_DECISION_XCD = "A" AND TRN_TYP IN ("C" "M" "P") AND 
			TRN_POS_ENT_CD IN ("E" "K" "G") AND TRN_AMT GT 0 AND CRD_CLNT_ID IN 
			("SC_CCMSSG_CR" "SC_CCMSIN_CR" "SC_CCMSMY_CR" "SC_CCMSBN_CR" 
			"SC_C400BW_CR" "SC_CCMSID_CR" "SC_C400BH_CR");
     FORMAT TRAN_DATE DATE9.;
     TRAN_DATE = INPUT(SUBSTR(TRN_DT,1,2) || SUBSTR(TRN_DT,4,3) || '20' || SUBSTR(TRN_DT,8,2),DATE9.);
     ATTRIB AUTH_DTTM FORMAT=DATETIME19.;
     AUTH_DTTM=DHMS(TRAN_DATE,SUBSTR(TRN_DT,11,2),SUBSTR(TRN_DT,14,2),SUBSTR(TRN_DT,17,2)); 
     MCC = INPUT(SIC_CD,BEST.);

	IF CRD_CLNT_ID IN ("SC_CCMSSG_CR" "SC_CCMSBN_CR") THEN USD = TRN_AMT/1.255698;
	ELSE IF CRD_CLNT_ID IN ("SC_CCMSMY_CR") THEN USD = TRN_AMT/3.221743;
	ELSE IF CRD_CLNT_ID IN ("SC_CCMSPH_CR") THEN USD = TRN_AMT/43.88082;
	ELSE IF CRD_CLNT_ID IN ("SC_CCMSTH_CR") THEN USD = TRN_AMT/32.675467;
	ELSE IF CRD_CLNT_ID IN ("SC_CCMSID_CR") THEN USD = TRN_AMT/11627.906977;
	ELSE IF CRD_CLNT_ID IN ("SC_CCMSIN_CR") THEN USD = TRN_AMT/63.75;
	ELSE IF CRD_CLNT_ID IN ("SC_CCMSTW_CR") THEN USD = TRN_AMT/30.116853;
	ELSE IF CRD_CLNT_ID IN ("SC_C400AE_CR") THEN USD = TRN_AMT/3.67;
	ELSE IF CRD_CLNT_ID IN ("SC_C400BH_CR") THEN USD = TRN_AMT/0.377132;
	ELSE IF CRD_CLNT_ID IN ("SC_C400BW_CR") THEN USD = TRN_AMT/10.2587;
	ELSE IF CRD_CLNT_ID IN ("SC_C400GH_CR") THEN USD = TRN_AMT/4.42718;
	ELSE IF CRD_CLNT_ID IN ("SC_C400JO_CR") THEN USD = TRN_AMT/0.708893;
	ELSE IF CRD_CLNT_ID IN ("SC_C400JE_CR") THEN USD = TRN_AMT/0.75;
	ELSE IF CRD_CLNT_ID IN ("SC_C400KE_CR") THEN USD = TRN_AMT/103.824;
	ELSE IF CRD_CLNT_ID IN ("SC_C400LK_CR") THEN USD = TRN_AMT/153.05;
	ELSE IF CRD_CLNT_ID IN ("SC_C400NG_CR") THEN USD = TRN_AMT/365.467;
	ELSE IF CRD_CLNT_ID IN ("SC_C400NP_CR") THEN USD = TRN_AMT/102.69;
	ELSE IF CRD_CLNT_ID IN ("SC_C400VN_CR") THEN USD = TRN_AMT/22727.50;
	ELSE IF CRD_CLNT_ID IN ("SC_C400ZM_CR") THEN USD = TRN_AMT/8.98193;
	ELSE IF CRD_CLNT_ID IN ("SC_CCMSHK_CR") THEN USD = TRN_AMT/7.8;
	ELSE IF CRD_CLNT_ID IN ("SC_C400BD_CR") THEN USD = TRN_AMT/83.60;
RUN;

PROC SORT DATA=FALT002 OUT=FALT002_1 NODUPKEY; BY FI_TRANSACTION_ID; RUN;

PROC SORT DATA=FALT002_1 OUT=FALT002_2; BY ACCT_NBR AUTH_DTTM; RUN;


%MACRO UDV(CUM_INTERVAL=, CUMULATIVE_CONDITION =, VAR_NAME=);

DATA FALT002_2;
     SET FALT002_2;
     BY ACCT_NBR AUTH_DTTM;

     FORMAT TIME_RESET_&VAR_NAME. DATETIME19.;

     RETAIN CUM_COUNT_&VAR_NAME. TIME_RESET_&VAR_NAME. CUM_AMOUNT_&VAR_NAME.;

     IF FIRST.ACCT_NBR THEN DO;
           TIME_RESET_&VAR_NAME. = 0;
           CUM_COUNT_&VAR_NAME. = 0;
           CUM_AMOUNT_&VAR_NAME. = 0;
     END;

     IF &CUMULATIVE_CONDITION. THEN DO;
           IF AUTH_DTTM LE (TIME_RESET_&VAR_NAME. + &CUM_INTERVAL.) THEN DO;
                CUM_COUNT_&VAR_NAME. + 1;
                CUM_AMOUNT_&VAR_NAME. + USD;
           END;
           ELSE DO;
                TIME_RESET_&VAR_NAME. = AUTH_DTTM;
                CUM_COUNT_&VAR_NAME. = 1;
                CUM_AMOUNT_&VAR_NAME. = USD;
           END;
     END;


RUN;
%MEND; 

%UDV(CUM_INTERVAL        = 3600,                                          
     CUMULATIVE_CONDITION= %STR(TRN_AUTH_POST = "A" AND AUTH_DECISION_XCD = "A" AND TRN_TYP IN ("C" "M" "P") AND 
								TRN_POS_ENT_CD IN ("E" "K" "G") AND TRN_AMT GT 0),
     VAR_NAME            = CNP_HOURLY);


%UDV(CUM_INTERVAL        = 86400,                                          
     CUMULATIVE_CONDITION= %STR(TRN_AUTH_POST = "A" AND AUTH_DECISION_XCD = "A" AND TRN_TYP IN ("C" "M" "P") AND 
								TRN_POS_ENT_CD IN ("E" "K" "G") AND TRN_AMT GT 0),
     VAR_NAME            = CNP_DAILY);



DATA INT_CNP_NONSEC_SCORE_1_SAS;

	SET FALT002_2;

	**************** Decision Rule HR_Global_Int_CNP_NonSec_Score_1 *****************;
IF 

(
(
 TRN_AUTH_POST  = "A" AND
 AUTH_DECISION_XCD  = "A" AND
 TRN_TYP  IN ("C" "M" "P") AND
 TRN_POS_ENT_CD  IN ("E" "K" "G") AND
 TRN_AMT  > 0 AND
 SUBSTR(USR_IND_4,1,2) NE "Y2"
)
and
(
(
 CRD_CLNT_ID  = "SC_CCMSSG_CR" AND
 MER_CNTY_CD  NE "702" AND
NOT(SIC_CD = ("7011")) AND
NOT(SIC_CD >= "3500" AND SIC_CD <= "3999") AND
NOT(MER_ID = ("000311160245883")) AND
(
( AA_SCOR  >= 995) OR
( AA_SCOR  >= 990 AND CUM_AMOUNT_CNP_HOURLY > 300) OR
( MER_CNTY_CD  = "036" AND  AA_SCOR  >= 920 AND CUM_AMOUNT_CNP_HOURLY > 700)
)
) 
OR
(
 CRD_CLNT_ID  = "SC_CCMSIN_CR" AND
 MER_CNTY_CD  NE "356" AND
(
 AA_SCOR  >= 990 OR
( AA_SCOR  >= 980 AND CUM_AMOUNT_CNP_HOURLY > 100)
)
) 
OR
(
 CRD_CLNT_ID  = "SC_CCMSMY_CR" AND
 MER_CNTY_CD  NE "458" AND
INDEX(UPCASE(MER_NM), "TAOBAO") AND
(
( AA_SCOR  >= 995) OR
( AA_SCOR  >= 990 AND CUM_AMOUNT_CNP_HOURLY > 150)
)
) 
OR
(
 CRD_CLNT_ID  = "SC_CCMSBN_CR" AND
 MER_CNTY_CD  NE "096" AND
(
( AA_SCOR  >= 990 AND USD > 60) OR
( AA_SCOR  >= 850 AND  AA_SCOR  < 960 AND CUM_COUNT_CNP_HOURLY >= 10 AND USD > 180)
)
)

OR

(
 CRD_CLNT_ID  = "SC_C400BW_CR" AND
 MER_CNTY_CD  NE "072" AND
 FRD_SCOR  >= 990
)

OR
(
 CRD_CLNT_ID  = "SC_CCMSID_CR" AND
 MER_CNTY_CD  NE "360" AND
(
( FRD_SCOR  >= 980 AND USD > 50) OR
( FRD_SCOR  >= 950 AND  FRD_SCOR  < 980 AND  MER_CNTY_CD  IN ("826" "702") AND USD > 100) OR
( FRD_SCOR  >= 920 AND  FRD_SCOR  < 980 AND  MER_CNTY_CD  IN ("826" "702") AND CUM_COUNT_CNP_DAILY >= 3 AND USD > 100) OR
( FRD_SCOR  >= 920 AND  FRD_SCOR  < 980 AND  MER_CNTY_CD  IN ("826" "702") AND CUM_AMOUNT_CNP_DAILY >= 5000000)
)
)

OR

(
 CRD_CLNT_ID  = "SC_C400BH_CR" AND
 MER_CNTY_CD  NE "048" AND
SIC_CD NE "5814" AND
(
(( AA_SCOR  >= 810 AND  AA_SCOR  <=900) AND
 MER_CNTY_CD  IN ("840" "826" "276" "442")) OR
 AA_SCOR  > 910
)
)
)
)
	
THEN FLAG = "Y";

RUN;

DATA TXN_DATA;
	SET INT_CNP_NONSEC_SCORE_1_SAS;
	WHERE FLAG="Y" AND DATE1 GE "03JUL2021"D; 
RUN;


DATA RULE_DATA;
     SET 
	 INC.falt003_cr_03JUL
INC.falt003_cr_04JUL;
WHERE UPCASE(RULE_NAME_STRG) IN ('HR_GLOBAL_INT_CNP_NONSEC_SCORE_1') AND CLIENT_XID IN 
			("SC_CCMSSG_CR" "SC_CCMSIN_CR" "SC_CCMSMY_CR" "SC_CCMSBN_CR" 
			"SC_C400BW_CR" "SC_CCMSID_CR" "SC_C400BH_CR") AND DATE1 GE "03JUL2021"D;
RUN;

PROC SORT DATA = RULE_DATA NODUPKEY ;BY FI_TRANSACTION_ID; RUN;


PROC FREQ DATA=TXN_DATA; TITLE "HR_GLOBAL_INT_CNP_NONSEC_SCORE_1 SAS"; 
TABLE CRD_CLNT_ID*DATE1/NOCOL NOROW NOPERCENT NOCUM; RUN;

PROC FREQ DATA=RULE_DATA; TITLE "HR_GLOBAL_INT_CNP_NONSEC_SCORE_1 FALCON HITS"; 
TABLE CLIENT_XID*DATE1/NOCOL NOROW NOPERCENT NOCUM; RUN;


/* Writing Outout to Excel - For Audit*/

ods listing;
ods excel file='C:\Users\1510806\Desktop\SAS\Outputs\HR_Global_Int_CNP_NonSec_Score_1 SG Credit.xlsx'
 options(sheet_interval="NONE");
 ods excel options(sheet_name="OUTPUT");
PROC FREQ DATA = TXN_DATA;TITLE "MR_Country_CNP_Google_Facebook_Test  SAS";
TABLE CRD_CLNT_ID*DATE1/NOCOL NOROW NOPERCENT NOCUM; RUN; 
PROC FREQ DATA = RULE_DATA; TITLE "MR_Country_CNP_Google_Facebook_Test  FALCON";
TABLE CLIENT_XID*DATE1/NOCOL NOROW NOPERCENT NOCUM; RUN;
ods excel close;
ods listing close;

PROC EXPORT DATA= TXN_DATA
outfile= "C:\Users\1510806\Desktop\SAS\Outputs\HR_Global_Int_CNP_NonSec_Score_1 SG Credit.xlsx"
dbms=xlsx replace;
sheet="TXN_DATA";
run;

PROC EXPORT DATA= RULE_DATA
outfile= "C:\Users\1510806\Desktop\SAS\Outputs\HR_Global_Int_CNP_NonSec_Score_1 SG Credit.xlsx"
dbms=xlsx replace;
sheet="RULE_DATA";
run;

PROC EXPORT DATA= CASACTN
outfile= "C:\Users\1510806\Desktop\SAS\Outputs\HR_Global_Int_CNP_NonSec_Score_1 SG Credit.xlsx"
dbms=xlsx replace;
sheet="CASACTN";
run;

PROC EXPORT DATA= OTHER_RULE
outfile= "C:\Users\1510806\Desktop\SAS\Outputs\HR_Global_Int_CNP_NonSec_Score_1 SG Credit.xlsx"
dbms=xlsx replace;
sheet="OTHER_RULE";
run;

/* 1 - Getting txns in Falcon not in SAS */
/* MER_ID is Name in VIP list Case manager */

PROC SQL;
CREATE TABLE txn_in_sas_not_in_rule AS 
SELECT SCORE_CUSTOMER_ACCOUNT_XID, FI_TRANSACTION_ID, CLIENT_XID FROM RULE_DATA where FI_TRANSACTION_ID not in (SELECT distinct(FI_TRANSACTION_ID) FROM 
TXN_DATA);
QUIT;


DATA UDV_Mismatch;
SET INT_CNP_NONSEC_SCORE_1_SAS;
WHERE FI_TRANSACTION_ID IN 
(
'0060df0d5a00a8db'
'0060df0d5a05c525'
'0060df0d5a05c659'
'0060df0d5a05c931'
'0260df0d5a009317'
'0260df0d5a0111c1'
'0360df0d8401290f'
'1e60df0c9900a686'
'1e60df0c9905990d'
'1e60df0c99059b0e'
'2060df0c99009083'
'2060df0c9900a81d'
'2160df0cc9012314'
'2160df0cc9012ad2'
'2160df0cc903a99f'
);
RUN;

PROC EXPORT DATA= UDV_Mismatch
outfile= "C:\Users\1510806\Desktop\SAS\Outputs\HR_Global_Int_CNP_NonSec_Score_1 SG Credit.xlsx"
dbms=xlsx replace;
sheet="UDV_Mismatch";
run;


/* 1 - Getting txns in SAS not in Falcon */
/* MER_ID is Name in VIP list Case manager */

PROC SQL;
CREATE TABLE txn_in_sas_not_in_rule AS 
SELECT ACCT_NBR, FI_TRANSACTION_ID, MER_ID, CRD_CLNT_ID FROM TXN_DATA where FI_TRANSACTION_ID not in (SELECT distinct(FI_TRANSACTION_ID) FROM 
RULE_DATA);
QUIT;


/* 2 - High priority rule check */

DATA OTHER_RULE;
SET 
INC.falt003_cr_03jul
INC.falt003_cr_04jul;
WHERE FI_TRANSACTION_ID IN 
(
'1f60df0c9900ab2c'
'0160df0d5a02e0c8'
'0260df0d5a058645'
'0260df0d5a0393c8'
'0260df0d5a039697'
'0260df0d5a038eb5'
'2060df0c99031ffe'
'0260df0d5a033fe4'
'0260df0d5a0226ca'
'2060df0c9904157a'
'0360df0d8400d79f'
'0160df0d5a00fee8'
'1e60df0c99037743'
) and
UPCASE(RULE_NAME_STRG) not IN ('HR_GLOBAL_INT_CNP_NONSEC_SCORE_1');
RUN;


/* 3 - Genuine list check */

DATA CASACTN;
SET INC.casactn_cr_03jul
INC.casactn_cr_04jul;
WHERE ACCT_NBR IN 
(
"4028748831753516"
"4028748833067121"
"4231798800432132"
"4541982339689025"
"4541982339689025"
"4541982339779925"
"5444385550363301"
"5444385550363301"
"5444385550369571"
"5498341641395492"
"5546232907523483"
"5546232908965410"
"5546232920381323"
) and date1 ge "03JUN2021"d;
RUN;



/**/
/**/
/******* SAS AND FALCON HITS COMPARISON ******;*/
/**/
/*%LET RULE = INT_CNP_NONSEC_SCORE_1;*/
/**/
/*PROC SQL;*/
/*CREATE TABLE CHK AS SELECT DISTINCT *, " " AS RULE_HIT FROM */
/*	((SELECT * FROM &RULE._SAS WHERE ACCT_NBR IN */
/*	(SELECT DISTINCT ACCT_NBR FROM &RULE.)) */
/*OUTER UNION CORR */
/*	(SELECT * FROM &RULE._SAS WHERE ACCT_NBR IN */
/*	(SELECT DISTINCT SCORE_CUSTOMER_ACCOUNT_XID FROM &RULE._RL)))*/
/*WHERE CRD_CLNT_ID IN ("SC_CCMSIN_CR" "SC_CCMSMY_CR")*/
/*ORDER BY ACCT_NBR, AUTH_DTTM;*/
/**/
/*UPDATE CHK SET RULE_HIT="Y" WHERE FI_TRANSACTION_ID IN (SELECT DISTINCT FI_TRANSACTION_ID FROM &RULE._RL);*/
/*QUIT;*/
/**/
/**/
/*PROC SQL;*/
/*CREATE TABLE CHK AS SELECT DISTINCT * FROM INC.FALT003_CR_22SEP WHERE FI_TRANSACTION_ID IN */
/*(SELECT DISTINCT FI_TRANSACTION_ID FROM INT_CNP_NONSEC_SCORE_1 WHERE UPCASE(DECI_CD) = "DECLINE");*/
/*QUIT;*/
/**/
/**/
/*DATA GENUINE;*/
/*SET INC.CASACTN_IN_CR_AUG2020*/
/*	INC.CASACTN_ID_CR_AUG2020*/
/*	INC.CASACTN_BH_CR_AUG2020*/
/*	INC.CASACTN_MY_CR_AUG2020;*/
/*WHERE ACCT_NBR IN */
/*('4622715355660617'*/
/*'4622735450842985'*/
/*'4835511572165682'*/
/*'5371780009022879'*/
/*'5404789862808912'*/
/*'5443043332236326'*/
/*'5520401753089496'*/
/*'5589595750058619'*/
/*) AND DATE1 GE "24AUG2020"D;*/
/*RUN;*/