

*************************************************************
				HR_Global_Merchant_MID  Credit

**************************************************************;
PROC IMPORT DATAFILE="C:\Users\1510806\Desktop\Jhilam\Daily Data\Hotlist\BLACKLISTED_MID_WITH_NAME_CREDIT.xlsx" DBMS=XLSX 
OUT=BLACKLISTED_MID_WITH_NAME_CR REPLACE;RUN;

OPTIONS VALIDVARNAME = ANY;

DATA BLACKLISTED_MID_WITH_NAME_CR_1;
SET BLACKLISTED_MID_WITH_NAME_CR;
NAME_1=SCAN(NAME,-2,":");
     FORMAT TRAN_DATE1 DATE9.;
     TRAN_DATE1 = MDY(SUBSTR('LAST UPDATED'N,1,2) , SUBSTR('LAST UPDATED'N,4,2) , SUBSTR('LAST UPDATED'N,7,4));
     ATTRIB LAST_UPDATED FORMAT=DATETIME19.;
     LAST_UPDATED=DHMS(TRAN_DATE1,SUBSTR('LAST UPDATED'N,12,2),SUBSTR('LAST UPDATED'N,15,2),SUBSTR('LAST UPDATED'N,18,2)); 
RUN;

LIBNAME INC "C:\Users\1510806\Desktop\Jhilam\Daily Data\CR";

DATA  FALT002;
     SET 
	 INC.FALT002_CR_16JUN 
	 INC.FALT002_CR_17JUN;   
     WHERE (	TRN_AUTH_POST = "A" and 
	(AUTH_DECISION_XCD = "A" or ((AUTH_DECISION_XCD)="" and DECI_CD_ORIG = "A")) and 
	TRN_TYP IN ("C"  "M"  "P"  "A") and 	TRN_POS_ENT_CD IN ("E"  "K"  "G")); 
/*	 and 	SUBSTR(USR_IND_4,1,2) NE "Y2" ) ; */
	IF SUBSTR(STRIP(CRD_CLNT_ID),LENGTH(STRIP(CRD_CLNT_ID))-4, 2) NOT IN ("HK" "TW" "BD" "ID") THEN TENANT = "Global"; 
	ELSE IF SUBSTR(STRIP(CRD_CLNT_ID),LENGTH(STRIP(CRD_CLNT_ID))-4, 2) IN ("HK") THEN TENANT = "HK";
	ELSE IF SUBSTR(STRIP(CRD_CLNT_ID),LENGTH(STRIP(CRD_CLNT_ID))-4, 2) IN ("TW") THEN TENANT = "TW";
	ELSE IF SUBSTR(STRIP(CRD_CLNT_ID),LENGTH(STRIP(CRD_CLNT_ID))-4, 2) IN ("BD") THEN TENANT = "BD";
	ELSE IF SUBSTR(STRIP(CRD_CLNT_ID),LENGTH(STRIP(CRD_CLNT_ID))-4, 2) IN ("ID") THEN TENANT = "ID";
	 FORMAT TRAN_DATE DATE9.;
     TRAN_DATE = INPUT(SUBSTR(TRN_DT,1,2) || SUBSTR(TRN_DT,4,3) || '20' || SUBSTR(TRN_DT,8,2),DATE9.);
     ATTRIB AUTH_DTTM FORMAT=DATETIME19.;
     AUTH_DTTM=DHMS(TRAN_DATE,SUBSTR(TRN_DT,11,2),SUBSTR(TRN_DT,14,2),SUBSTR(TRN_DT,17,2)); 
RUN;

PROC SORT DATA=FALT002 NODUPKEY; BY FI_TRANSACTION_ID; RUN;


PROC SQL;
CREATE TABLE FALT002_2 AS SELECT A.*,B.NAME ,B.VALUE FROM
(SELECT * FROM FALT002 WHERE COMPRESS(MER_ID) IN 
(SELECT DISTINCT NAME_1 FROM BLACKLISTED_MID_WITH_NAME_CR_1)) A
LEFT JOIN 
BLACKLISTED_MID_WITH_NAME_CR_1 B 
ON COMPRESS(A.MER_ID) = B.NAME_1
/************************************************************/
WHERE A.AUTH_DTTM GE B.LAST_UPDATED;
QUIT;


DATA HR_Global_Merchant_MID_Test_SAS;
SET FALT002_2;
IF INDEX(MER_NM,STRIP(VALUE)) > 0 THEN FLAG = "Y";
RUN;

DATA TXN_DATA;
SET HR_Global_Merchant_MID_Test_SAS;
WHERE FLAG = "Y" and  date1 GE "17JUN2021"D;
RUN;

DATA RULE_DATA;
 SET 
 INC.falt003_cr_16JUN	
 INC.falt003_cr_17JUN;
WHERE UPCASE(RULE_NAME_STRG) IN ('HR_GLOBAL_MERCHANT_MID') and date1 GE "17JUN2021"D;
	IF SUBSTR(STRIP(CLIENT_XID),LENGTH(STRIP(CLIENT_XID))-4, 2) NOT IN ("HK" "TW" "BD" "ID") THEN TENANT = "Global"; 
	ELSE IF SUBSTR(STRIP(CLIENT_XID),LENGTH(STRIP(CLIENT_XID))-4, 2) IN ("HK") THEN TENANT = "HK";
	ELSE IF SUBSTR(STRIP(CLIENT_XID),LENGTH(STRIP(CLIENT_XID))-4, 2) IN ("TW") THEN TENANT = "TW";
	ELSE IF SUBSTR(STRIP(CLIENT_XID),LENGTH(STRIP(CLIENT_XID))-4, 2) IN ("BD") THEN TENANT = "BD";
	ELSE IF SUBSTR(STRIP(CLIENT_XID),LENGTH(STRIP(CLIENT_XID))-4, 2) IN ("ID") THEN TENANT = "ID";
RUN;

PROC SORT DATA = RULE_DATA NODUPKEY ;BY FI_TRANSACTION_ID; RUN;

PROC FREQ DATA=TXN_DATA; TITLE "HR_Global_Merchant_MID_Test SAS"; 
TABLE TENANT*DATE1/NOCOL NOROW NOPERCENT NOCUM;  RUN;

PROC FREQ DATA=RULE_DATA; TITLE "HR_Global_Merchant_MID_Test FALCON HITS"; 
TABLE TENANT*DATE1/NOCOL NOROW NOPERCENT NOCUM; RUN;


ods listing;
ods excel file='C:\Users\1510806\Desktop\SAS\Outputs\HR_Global_Merchant_MID Credit.xlsx'
 options(sheet_interval="NONE");
 ods excel options(sheet_name="OUTPUT");
PROC FREQ DATA = TXN_DATA;TITLE "HR_Global_Merchant_MID SAS";
TABLE CRD_CLNT_ID*DATE1/NOCOL NOROW NOPERCENT NOCUM; RUN; 
PROC FREQ DATA = RULE_DATA; TITLE "HR_Global_Merchant_MID FALCON";
TABLE CLIENT_XID*DATE1/NOCOL NOROW NOPERCENT NOCUM; RUN;
ods excel close;
ods listing close;

PROC EXPORT DATA= TXN_DATA
outfile= "C:\Users\1510806\Desktop\SAS\Outputs\HR_Global_Merchant_MID Credit.xlsx"
dbms=xlsx replace;
sheet="TXN_DATA";
run;

PROC EXPORT DATA= RULE_DATA
outfile= "C:\Users\1510806\Desktop\SAS\Outputs\HR_Global_Merchant_MID Credit.xlsx"
dbms=xlsx replace;
sheet="RULE_DATA";
run;


PROC EXPORT DATA= CASACTN
outfile= "C:\Users\1510806\Desktop\SAS\Outputs\HR_Global_Merchant_MID Credit.xlsx"
dbms=xlsx replace;
sheet="CASACTN";
run;


/*CROSS CHECK* - 5 STEPS */

/********************** cross check 4 STEPS ***********************/

/* 1 - Getting txns in SAS not in Falcon */
/* MER_ID is Name in VIP list Case manager */

PROC SQL;
CREATE TABLE txn_in_sas_not_in_rule AS 
SELECT ACCT_NBR, FI_TRANSACTION_ID, MER_ID, CRD_CLNT_ID FROM TXN_DATA where FI_TRANSACTION_ID not in (SELECT distinct(FI_TRANSACTION_ID) FROM 
RULE_DATA);
QUIT;


/* 2 - High priority rule check */

DATA OTHER_RULE;
SET 
INC.falt003_cr_16jun
INC.falt003_cr_17jun;
WHERE FI_TRANSACTION_ID IN 
(
'0360c9d87800b22c'
) and
UPCASE(RULE_NAME_STRG) not IN ('HR_GLOBAL_MERCHANT_MID');
RUN;


/* 3 - Genuine list check */

DATA CASACTN;
SET INC.casactn_cr_16jun
INC.casactn_cr_17jun;
WHERE ACCT_NBR IN 
(
"5444387755004417"
) and date1 ge "16JUN2021"d;
RUN;

/* 4 - If not solved in previous steps chec those ACCT_NBRs here*/
/* MER_ID or Name extraction for ACCT_NBS in SAS not in Falcon*/

PROC SQL;
CREATE TABLE VIP AS 
SELECT distinct(MER_ID), FI_TRANSACTION_ID FROM Txn_Data where ACCT_NBR in
(
'5523438412256975'
);
RUN;

/* 5 - Check if the ACCT_NBR is present in VIP list (Case manager)*/

DATA VIP_LIST;
SET LOOKUP_DATA;
WHERE
NAME IN(
'484767000200403'
'EP86CJLWQYAQGJM'
);
RUN;

/********************** cross check 5 STEPS ***********************/



/**/
/**/
/**/
/*/*MISMATCH CHECKING*/*/
/**/
/**/
/*data chk;*/
/*set inc.casactn_cr_17jul*/
/*	inc.casactn_cr_18jul*/
/*	inc.casactn_cr_19jul;*/
/*where acct_nbr in ('5444385550379182'*/
/*'5523438411022014'*/
/*'5523438411024325'*/
/*'5523438411028615'*/
/*'5523438411031585'*/
/*'5523438411032484'*/
/*'5523438411032724'*/
/*'5523438411033102'*/
/*'5523438411035230'*/
/*'5523438411035511'*/
/*'5523438411035578'*/
/*'5523438411037707'*/
/*'5523438411037715'*/
/*'5523438411038143'*/
/*'5523438411038408'*/
/*'5523438411045106'*/
/*'5523438411051211'*/
/*'5523438411051260'*/
/*'5523438411054462'*/
/*'5523438411054785'*/
/*'5523438411055055'*/
/*'5523438411055543'*/
/*'5523438411056574'*/
/*'5523438411056855'*/
/*'5523438411057531'*/
/*'5523438411058562'*/
/*'5523438411061418'*/
/*'5523438411062002'*/
/*'5523438411062622'*/
/*'5523438411063372'*/
/*'5523438411063786'*/
/*'5523438411064206'*/
/*'5523438411064404'*/
/*'5523438411064776'*/
/*'5523438411067050'*/
/*'5523438411067134'*/
/*'5523438411070831'*/
/*'5523438411071243'*/
/*'5523438411073736'*/
/*'5523438411073868'*/
/*'5523438411074023'*/
/*'5523438411075657'*/
/*'5523438411076150'*/
/*'5523438411077018'*/
/*'5523438411077281'*/
/*'5523438411077828'*/
/*'5523438411078321'*/
/*'5523438411086175'*/
/*'5523438411086381'*/
/*);*/
/*run;*/
/**/
/*DATA CASACTN_HK;*/
/*SET INC.casactn_hk_cr_jun2019;*/
/*WHERE ACCT_NBR IN ('5523438412222407');*/
/*RUN;*/
/**/
/*DATA CASACTN_HK;*/
/*SET INC.falt003_cr_30jun;*/
/*WHERE score_customer_account_xid IN ('5523438412222407');*/
/*RUN;*/
/**/
/**/
/*DATA HR_GLOBAL_MERCHANT_DECLINE_RL;*/
/*SET INC.falt003_cr_29jun	INC.falt003_cr_30jun;*/
/*WHERE UPCASE(RULE_NAME_STRG) IN ('HR_GLOBAL_MERCHANT_DECLINE') ;*/
/*RUN;*/
/**/
PROC SORT DATA = HR_GLOBAL_MERCHANT_DECLINE_RL NODUPKEY ;
/*BY FI_TRANSACTION_ID; RUN;*/
/**/
/*PROC SQL;*/
/*CREATE TABLE CHK1 AS*/
/*SELECT A.*,B.RULE_NAME_STRG AS NEW_RULE_NAME_STRG FROM */
/*HR_GLOBAL_MERCHANT_MID_TEST_RL A LEFT JOIN HR_GLOBAL_MERCHANT_DECLINE_RL B*/
/*ON A.FI_TRANSACTION_ID = B.FI_TRANSACTION_ID;*/
/*QUIT;*/
/**/
/**/
/*PROC SQL;*/
/*CREATE TABLE CHK2 AS*/
/*SELECT A.*,B.RULE_NAME_STRG AS NEW_RULE_NAME_STRG FROM */
/*HR_GLOBAL_MERCHANT_DECLINE_RL A LEFT JOIN HR_GLOBAL_MERCHANT_MID_TEST_RL B*/
/*ON A.FI_TRANSACTION_ID = B.FI_TRANSACTION_ID;*/
/*QUIT;*/
/**/
/**/
/*DATA NOT_HR_GLOBAL_MERCHANT_MID_TEST;*/
/*SET FALT002;*/
/*WHERE FI_TRANSACTION_ID IN (*/
/*'025d162bf70374a5'*/
/*'025d162bf7037e1f'*/
/*'025d162bf70382ab'*/
/*'0c5d162b44036a76'*/
/*'0c5d162b4403f059');*/
/*RUN;*/
/**/
/**/
/*DATA NOT_HR_GLOBAL_MERCHANT_DECLINE;*/
/*SET FALT002;*/
/*WHERE FI_TRANSACTION_ID IN (*/
/*'005d162bf700cdaa'*/
/*'005d162bf703cfd6'*/
/*'015d162bf7008cf9'*/
/*'015d162bf700cb52'*/
/*'015d162bf706078c'*/
/*'0b5d162b4405e8da');*/
/*RUN;*/
/**/
/*DATA CHK3;*/
/*SET INC.falt003_cr_29jun	INC.falt003_cr_30jun;*/
/*WHERE FI_TRANSACTION_ID IN (*/
/*'005d162bf700cdaa'*/
/*'005d162bf703cfd6'*/
/*'015d162bf7008cf9'*/
/*'015d162bf700cb52'*/
/*'015d162bf706078c'*/
/*'0b5d162b4405e8da');*/
/*RUN;*/
/**/
/*PROC SORT DATA=CHK3;BY FI_TRANSACTION_ID;RUN;*/
/**/
/**/
/*DATA CHK4;*/
/*SET FALT002;*/
/*WHERE FI_TRANSACTION_ID IN (*/
/*'0c5d162b4403f059');*/
/*RUN;*/