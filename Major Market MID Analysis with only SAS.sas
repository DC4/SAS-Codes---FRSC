
**************************************************************************************

				Merchant Impact for Non Major

**************************************************************************************;
 
LIBNAME EXIST "C:\Users\1549580\Desktop\Jhilam\Falcon 6.4 Monthly Data";

%LET TOD = %SYSFUNC(TODAY(),date9.);
%put &tod.;

*********************************************************;

LIBNAME DB "C:\Users\1549580\Desktop\Jhilam\Falcon 6.4 Monthly Data\Debit";

PROC DELETE DATA=mernm_top5; RUN;

%MACRO COP(CNTY);

DATA XX;
SET DB.FALT002_&CNTY._DB_SEP2020
	DB.FALT002_&CNTY._DB_OCT2020
	DB.FALT002_&CNTY._DB_NOV2020
	DB.FALT002_&CNTY._DB_DEC2020;
WHERE STRIP(MER_ID) IN 
('248748000103177'
'248745000103177'
'YESBANK1237054'
'399801057040000'
'248741000103177'
'470000000218060'
'997200014459422'
'720019481'
'4126000000371'
'4126000000381'
'3TNLMP3MX7OZHAS'
'421282365889'
'879551000822973'
'BRH3DWI8M6USKZ7'
'201100019976000'
'311013092888'
'932000001452704'
'000311035225888'
'000445381699997'
'498750002387323'
'353109297315633'
'168700013517'
'350862000156182'
'458711000144949'
'23459514'
'311204404884'
'XRQSCPQQSZ4PNGS'
'75102301'
'5006811122541'
'006656800001000'
'472545696'
'517649000202897'
'4556692886'
'L3EHFEOLUIJ6YGA'
'145389682'
'389811000388629'
'000445525289994'
'BU4TAISW1BPPVQC'
'0726680   00000'
'145415437'
'000372655766882'
'227210000067204'
'3005447'
'135000037000005'
'000027007714546'
'10000001000'
'5500657208'
'1492975'
'BWMK89BNYZLQVNP'
'355816894012231'
'311178832888'
'009772089'
'000001110262987'
);
RUN;

PROC APPEND DATA=XX BASE=mernm_top5; RUN;

%MEND;

%COP(AE);
%COP(IN);
%COP(MY);
%COP(SG);
%COP(HK);

PROC SORT DATA=EXIST.FRD15 OUT=FRD_15 NODUPKEY; 
	BY PAN FITRANSACTIONIDREFERENCE; 
RUN;

PROC SORT DATA=mernm_top5 ; BY ACCT_NBR FI_TRANSACTION_ID DESCENDING FRD_IND; RUN;
PROC SORT DATA=mernm_top5 NODUPKEY; BY ACCT_NBR FI_TRANSACTION_ID; RUN;

PROC IMPORT DATAFILE="C:\Users\1549580\Desktop\Jhilam\Dispute Merchant Analysis\Dispute Cases.xlsx" OUT=Dispute_txn dbms=xlsx replace; sheet="txn_id"; run;
PROC IMPORT DATAFILE="C:\Users\1549580\Desktop\Jhilam\Dispute Merchant Analysis\Global_Dispute_Fraud_FI.xlsx" OUT=Global_Dispute_Fraud_FI dbms=xlsx replace; run;

PROC SQL;
CREATE TABLE TXN_DETAILS AS
		SELECT A.*,
		  B.FRAUDFLAG,
		  CASE 
			WHEN STRIP(UPCASE(A.FRD_IND)) IN ("Y" "D") OR B.FRAUDFLAG="1" OR C.FI_TRANSACTION_ID NE ""  OR D.FI_TRANSACTION_ID NE "" THEN 1 
		  END AS FRAUD
FROM mernm_top5 AS A LEFT JOIN FRD_15 AS B ON 
STRIP(A.CRD_CLNT_ID)=STRIP(B.CLIENTIDFROMHEADER) AND
STRIP(A.FI_TRANSACTION_ID)=STRIP(B.FITRANSACTIONIDREFERENCE)
LEFT JOIN Global_Dispute_Fraud_FI AS C ON 
STRIP(A.FI_TRANSACTION_ID)=STRIP(C.FI_TRANSACTION_ID)
LEFT JOIN Dispute_txn AS D ON
STRIP(A.FI_TRANSACTION_ID) = STRIP(D.FI_TRANSACTION_ID);
QUIT;

PROC SORT DATA=TXN_DETAILS NODUPKEY; BY FI_TRANSACTION_ID; RUN;

DATA FALT002;
     SET TXN_DETAILS;
   
     WHERE TRN_AUTH_POST="A" AND (AUTH_DECISION_XCD="A" OR DECI_CD_ORIG="A") AND TRN_TYP IN ("C" "M" "P");

     FORMAT TRAN_DATE DATE9.;
     TRAN_DATE = INPUT(SUBSTR(TRN_DT,1,2) || SUBSTR(TRN_DT,4,3) || '20' || SUBSTR(TRN_DT,8,2),DATE9.);
     ATTRIB AUTH_DTTM FORMAT=DATETIME19.;
     AUTH_DTTM=DHMS(TRAN_DATE,SUBSTR(TRN_DT,11,2),SUBSTR(TRN_DT,14,2),SUBSTR(TRN_DT,17,2)); 
	 COUNTRY = CRD_CLNT_ID;

	 OUTPUT;
	 IF CRD_CLNT_ID NE "" THEN DO; COUNTRY = "All_DB"; OUTPUT; END;
RUN;


PROC SQL;
CREATE TABLE db_Impact_Summary AS 
SELECT DISTINCT mer_id, COUNTRY, 
		COUNT(DISTINCT FI_TRANSACTION_ID) AS TXN_COUNT, 
		COUNT(DISTINCT ACCT_NBR) AS ACCT_COUNT, 
		SUM(FRAUD) AS NO_OF_FRAUDS,
		COUNT(DISTINCT CASE WHEN FRAUD=1 THEN ACCT_NBR END) AS NO_OF_CARDS_FRAUD, 
		CASE 
		 WHEN SUM(FRAUD) NE . THEN CALCULATED TXN_COUNT/CALCULATED NO_OF_FRAUDS
		 ELSE CALCULATED TXN_COUNT
		END AS TFPR,
		CASE 
		 WHEN SUM(FRAUD) NE . THEN CALCULATED ACCT_COUNT/CALCULATED NO_OF_CARDS_FRAUD
		 ELSE CALCULATED ACCT_COUNT
		END AS AFPR,
		ROUND(CALCULATED ACCT_COUNT/90,1) AS IMPACT_PER_DAY
FROM FALT002
group by mer_id, COUNTRY;
QUIT;





**************************************************************************************

				Credit Impact Summary

**************************************************************************************;


LIBNAME EXIST "C:\Users\1549580\Desktop\Jhilam\Falcon 6.4 Monthly Data";

*********************************************************;


LIBNAME CR "C:\Users\1549580\Desktop\Jhilam\Falcon 6.4 Monthly Data\Credit";

PROC DELETE DATA=mernm_top5; RUN;

%MACRO COP(CNTY);

DATA XX;
SET CR.FALT002_&CNTY._CR_SEP2020
	CR.FALT002_&CNTY._CR_OCT2020
	CR.FALT002_&CNTY._CR_NOV2020
	CR.FALT002_&CNTY._CR_DEC2020;
WHERE STRIP(MER_ID) IN 
('248748000103177'
'248745000103177'
'YESBANK1237054'
'399801057040000'
'248741000103177'
'470000000218060'
'997200014459422'
'720019481'
'4126000000371'
'4126000000381'
'3TNLMP3MX7OZHAS'
'421282365889'
'879551000822973'
'BRH3DWI8M6USKZ7'
'201100019976000'
'311013092888'
'932000001452704'
'000311035225888'
'000445381699997'
'498750002387323'
'353109297315633'
'168700013517'
'350862000156182'
'458711000144949'
'23459514'
'311204404884'
'XRQSCPQQSZ4PNGS'
'75102301'
'5006811122541'
'006656800001000'
'472545696'
'517649000202897'
'4556692886'
'L3EHFEOLUIJ6YGA'
'145389682'
'389811000388629'
'000445525289994'
'BU4TAISW1BPPVQC'
'0726680   00000'
'145415437'
'000372655766882'
'227210000067204'
'3005447'
'135000037000005'
'000027007714546'
'10000001000'
'5500657208'
'1492975'
'BWMK89BNYZLQVNP'
'355816894012231'
'311178832888'
'009772089'
'000001110262987');
RUN;

PROC APPEND DATA=XX BASE=mernm_top5; RUN;

%MEND;

%COP(AE);
%COP(IN);
%COP(MY);
%COP(SG);
%COP(HK);

PROC SORT DATA=EXIST.FRD15 OUT=FRD_15 NODUPKEY; 
	BY PAN FITRANSACTIONIDREFERENCE; 
RUN;

PROC SORT DATA=mernm_top5 ; BY ACCT_NBR FI_TRANSACTION_ID DESCENDING FRD_IND; RUN;
PROC SORT DATA=mernm_top5 NODUPKEY; BY ACCT_NBR FI_TRANSACTION_ID; RUN;

PROC IMPORT DATAFILE="C:\Users\1549580\Desktop\Jhilam\Dispute Merchant Analysis\Dispute Cases.xlsx" OUT=Dispute_txn dbms=xlsx replace; sheet="txn_id"; run;
PROC IMPORT DATAFILE="C:\Users\1549580\Desktop\Jhilam\Dispute Merchant Analysis\Global_Dispute_Fraud_FI.xlsx" OUT=Global_Dispute_Fraud_FI dbms=xlsx replace; run;

PROC SQL;
CREATE TABLE TXN_DETAILS AS
		SELECT A.*,
		  B.FRAUDFLAG,
		  CASE 
			WHEN STRIP(UPCASE(A.FRD_IND)) IN ("Y" "D") OR B.FRAUDFLAG="1" OR C.FI_TRANSACTION_ID NE "" OR D.FI_TRANSACTION_ID NE "" THEN 1 
		  END AS FRAUD
FROM mernm_top5 AS A LEFT JOIN FRD_15 AS B ON 
STRIP(A.CRD_CLNT_ID)=STRIP(B.CLIENTIDFROMHEADER) AND
STRIP(A.FI_TRANSACTION_ID)=STRIP(B.FITRANSACTIONIDREFERENCE)
LEFT JOIN Global_Dispute_Fraud_FI AS C ON 
STRIP(A.FI_TRANSACTION_ID)=STRIP(C.FI_TRANSACTION_ID)
LEFT JOIN Dispute_txn AS D ON
STRIP(A.FI_TRANSACTION_ID) = STRIP(D.FI_TRANSACTION_ID);
QUIT;

PROC SORT DATA=TXN_DETAILS NODUPKEY; BY FI_TRANSACTION_ID; RUN;

DATA FALT002;
     SET TXN_DETAILS;
   
     WHERE TRN_AUTH_POST="A" AND (AUTH_DECISION_XCD="A" OR DECI_CD_ORIG="A") AND TRN_TYP IN ("C" "M" "P");

     FORMAT TRAN_DATE DATE9.;
     TRAN_DATE = INPUT(SUBSTR(TRN_DT,1,2) || SUBSTR(TRN_DT,4,3) || '20' || SUBSTR(TRN_DT,8,2),DATE9.);
     ATTRIB AUTH_DTTM FORMAT=DATETIME19.;
     AUTH_DTTM=DHMS(TRAN_DATE,SUBSTR(TRN_DT,11,2),SUBSTR(TRN_DT,14,2),SUBSTR(TRN_DT,17,2)); 
	 COUNTRY = CRD_CLNT_ID;

	 OUTPUT;
	 IF CRD_CLNT_ID NE "" THEN DO; COUNTRY = "All_CR"; OUTPUT; END;
RUN;


PROC SQL;
CREATE TABLE CR_Impact_Summary AS 
SELECT DISTINCT mer_id, COUNTRY, 
		COUNT(DISTINCT FI_TRANSACTION_ID) AS TXN_COUNT, 
		COUNT(DISTINCT ACCT_NBR) AS ACCT_COUNT, 
		SUM(FRAUD) AS NO_OF_FRAUDS,
		COUNT(DISTINCT CASE WHEN FRAUD=1 THEN ACCT_NBR END) AS NO_OF_CARDS_FRAUD, 
		CASE 
		 WHEN SUM(FRAUD) NE . THEN CALCULATED TXN_COUNT/CALCULATED NO_OF_FRAUDS
		 ELSE CALCULATED TXN_COUNT
		END AS TFPR,
		CASE 
		 WHEN SUM(FRAUD) NE . THEN CALCULATED ACCT_COUNT/CALCULATED NO_OF_CARDS_FRAUD
		 ELSE CALCULATED ACCT_COUNT
		END AS AFPR,
		ROUND(CALCULATED ACCT_COUNT/90,1) AS IMPACT_PER_DAY
FROM FALT002
group by mer_id, COUNTRY;
QUIT;


data impact_summary_&TOD.;
set db_impact_summary
	cr_impact_summary;
run;